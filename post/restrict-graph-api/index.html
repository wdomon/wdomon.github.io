<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='Graph API permissions via EntraID app registrations have become even more popular over the last couple of years. While they are definitely an upgrade over old school &ldquo;service accounts,&rdquo; granting an app access to an Exchange Online(EXO) mailbox or a Teams/Sharepoint Online(SPO) site using Graph API permissions can result in far more permissions being granted than are needed (or realized).
Many 3rd party applications/vendors, and even flows built within your own Power Automate tenant, etc.'><title>Restrict Graph API Permissions for Exchange Online or Teams/Sharepoint Online</title>
<link rel=canonical href=https://adminbraindump.com/post/restrict-graph-api/><link rel=stylesheet href=/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css><meta property='og:title' content='Restrict Graph API Permissions for Exchange Online or Teams/Sharepoint Online'><meta property='og:description' content='Graph API permissions via EntraID app registrations have become even more popular over the last couple of years. While they are definitely an upgrade over old school &ldquo;service accounts,&rdquo; granting an app access to an Exchange Online(EXO) mailbox or a Teams/Sharepoint Online(SPO) site using Graph API permissions can result in far more permissions being granted than are needed (or realized).
Many 3rd party applications/vendors, and even flows built within your own Power Automate tenant, etc.'><meta property='og:url' content='https://adminbraindump.com/post/restrict-graph-api/'><meta property='og:site_name' content='Admin Brain Dump'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2024-08-25T08:15:56-07:00'><meta property='article:modified_time' content='2024-08-25T08:15:56-07:00'><meta name=twitter:title content="Restrict Graph API Permissions for Exchange Online or Teams/Sharepoint Online"><meta name=twitter:description content="Graph API permissions via EntraID app registrations have become even more popular over the last couple of years. While they are definitely an upgrade over old school &ldquo;service accounts,&rdquo; granting an app access to an Exchange Online(EXO) mailbox or a Teams/Sharepoint Online(SPO) site using Graph API permissions can result in far more permissions being granted than are needed (or realized).
Many 3rd party applications/vendors, and even flows built within your own Power Automate tenant, etc."><script async src="https://www.googletagmanager.com/gtag/js?id=G-NBJPVX4KDE"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NBJPVX4KDE")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/brain_logo_hu13371057242758227865.png width=300 height=326 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ðŸ’©</span></figure><div class=site-meta><h1 class=site-name><a href=/>Admin Brain Dump</a></h1><h2 class=site-description>A mostly organized brain dump</h2></div></header><ol class=social-menu><li><a href=https://github.com/wdomon target=_blank title=GitHub><svg class="icon icon-tabler icon-tabler-brand-github" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://adminbraindump.com/ selected></option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/post/restrict-graph-api/>Restrict Graph API Permissions for Exchange Online or Teams/Sharepoint Online</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Aug 25, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><p>Graph API permissions via EntraID app registrations have become even more popular over the last couple of years. While they are definitely an upgrade over old school &ldquo;service accounts,&rdquo; granting an app access to an Exchange Online(EXO) mailbox or a Teams/Sharepoint Online(SPO) site using Graph API permissions can result in far more permissions being granted than are needed (or realized).</p><p>Many 3rd party applications/vendors, and even flows built within your own Power Automate tenant, etc. will request an app registration with a list of Graph API permissions that their app &ldquo;needs.&rdquo; If this app requires the ability to access a single mailbox, for example, they will request <code>Mail.Read</code> or <code>Mail.ReadWrite</code> as the application permission they need. However, what some people don&rsquo;t pick up on is that this is actually granting this app permission to access EVERY mailbox in the entire tenant; shared mailboxes, user mailboxes, resource mailboxes, the CEO/CFO&rsquo;s mailbox&mldr; you get the point. Granting <code>Sites.Read.All</code> or <code>Sites.ReadWrite.All</code> do the same for every Teams/OneDrive/SPO site as well. Luckily, Microsoft has introduced features in Microsoft Graph that provide more granular control over app access to specific SPO/Teams site collections and Exchange Online mailboxes. This post will walk you through the process of configuring these features to ensure that your applications only have access to the necessary resources.</p><h3 id=scoping-microsoft-graph-permissions-for-exchange-online-mailboxes>Scoping Microsoft Graph Permissions for Exchange Online Mailboxes</h3><p>A significant enhancement is the ability to scope Microsoft Graph permissions to specific Exchange Online mailboxes using the Application Access Policy feature. This is particularly useful in scenarios where an app needs to access only a subset of mailboxes within an organization. This feature is actually just a configuration within EXO using the <a class=link href=https://www.powershellgallery.com/packages/ExchangeOnlineManagement/3.5.1 target=_blank rel=noopener>ExchangeOnlineManagement</a> Powershell module and not with MS Graph itself.</p><h4 id=configure-application-access-policy>Configure Application Access Policy</h4><ol><li><p>Connect to Exchange Online PowerShell: First, connect to Exchange Online PowerShell. You can use the Azure Cloud Shell or any other preferred method to do this.</p></li><li><p>Identify the App and Security Group: Identify your appâ€™s clientID and either create a new mail-enabled security group or use an existing one; identify the email address of this group. This group will be used to control the app&rsquo;s access to specific mailboxes. You will add the user account for each mailbox the app needs to access as members of the group (including the disabled accounts associated with shared mailboxes).</p></li><li><p>Create an Application Access Policy: Run the following command to create a policy that restricts the appâ€™s access to the mailboxes within the specified security group</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$appId = &lt;insert clientID of app registration&gt;
</span></span><span style=display:flex><span>$groupId = &lt;insert email address of mail-enabled security group&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>New-ApplicationAccessPolicy -AppId $appId -PolicyScopeGroupId $groupId -AccessRight RestrictAccess -Description <span style=color:#e6db74>&#34;Scopes down appregX to just mailboxes in groupY&#34;</span>
</span></span></code></pre></div><p><strong>NOTE: This often takes 1-2 hours to take effect once created</strong></p></li></ol><p>As you can see, the restriction is actually behing handled by Exchange so the app still has the broad permissions that were originally requested but in practice it will get an &ldquo;Access Denied&rdquo; if it tries to access any mailbox that is not in the group. By using this policy, you can ensure that your application only accesses the mailboxes that are explicitly needed, improving your organizationâ€™s security and compliance posture.</p><h3 id=restricting-app-access-to-teamssharepoint-online-site-collections>Restricting App Access to Teams/SharePoint Online Site Collections</h3><p>As mentioned previously, granting application permissions for SPO/Teams via Microsoft Graph was an all-or-nothing proposition, with apps having access to all site collections within a tenant. However, Microsoft has introduced a new permission called <code>Sites.Selected</code>, which allows administrators to limit app access to specific site collections. Unlike the access policy outlined above, this is done within MS Graph itself by replacing the requested <code>Sites.Read.All</code> or <code>Sites.ReadWrite.All</code> permissions with the <code>Sites.Selected</code> instead.</p><h4 id=steps-to-configure-access>Steps to Configure Access:</h4><p>While technically granting your application access to a particular site collection only requires a single API call, there&rsquo;s a process that you&rsquo;ll need to follow in order to accomplish that call:</p><ol><li><p><strong>Assign the <code>Sites.Selected</code> Permission</strong>:
Begin by assigning the <code>Sites.Selected</code> permission to your application. This can be done in the EntraID app registration portal. By default, this permission does <strong>NOT</strong> grant access to any site collections.</p></li><li><p><strong>Create/use an app registration that has <code>Sites.FullControl.All</code> (appregA)</strong></p><ul><li>This will be used to APPLY the permission to the restricted app registration</li><li>A temporary app registration can be created for this as long as it is deleted afterwards</li></ul></li><li><p><strong>Create/identify an app registration that has Sites.Selected (appregB)</strong></p><ul><li>This will be granted the API permission to the targeted Teams/SPO site(s)</li></ul></li><li><p><strong>API call to output an access token for appregA</strong></p><ul><li>Type: <code>POST</code></li><li>Uri: <code>https://login.microsoftonline.com/&lt;tenantId>/oauth2/v2.0/token</code></li><li>Body<ul><li>Grant_Type: <code>client_credentials</code></li><li>Scope: <code>https://graph.microsoft.com/.default</code></li><li>Client_Id: <code>&lt;clientID fo appregA></code></li><li>Client_Secret: <code>&lt;clientSecret of appregA></code></li></ul></li></ul></li><li><p><strong>Copy value of &ldquo;access_token&rdquo; in response</strong></p></li><li><p><strong>API call to find &ldquo;siteID&rdquo; of Teams/SPO site(s) wanting to allow an app registration to</strong></p><ul><li>Type: <code>GET</code></li><li>Uri: <code>https://graph.microsoft.com/v1.0/sites/uticorp.sharepoint.com:/sites/&lt;displayNameOfSite></code></li><li>Authorization: <code>"Bearer &lt;access token for appregA>"</code></li></ul></li><li><p><strong>Copy middle value of &ldquo;id&rdquo; in response</strong></p><ul><li>&ldquo;id&rdquo; in response will contain a comma-separated string and the siteID is the middle value</li><li>Example:</li></ul></li><li><p><strong>API call to apply Teams/SPO site permissions to appregB</strong></p><ul><li>Type: <code>POST</code></li><li>Uri: <code>https://graph.microsoft.com/v1.0/sites/&lt;siteID>/permissions</code></li><li>Authorization: <code>"Bearer &lt;access token for appregA>"</code></li><li>Body:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{
</span></span><span style=display:flex><span>    &#34;roles&#34;: [&#34;write&#34;],
</span></span><span style=display:flex><span>    &#34;grantedToIdentities&#34;: [{
</span></span><span style=display:flex><span>    &#34;application&#34;: {
</span></span><span style=display:flex><span>        &#34;id&#34;: &#34;&lt;clientID of appregB&gt;&#34;,
</span></span><span style=display:flex><span>        &#34;displayName&#34;: &#34;&lt;DisplayName of appregB&gt;&#34;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    }]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div>Insert the clientID and DisplayName of appregB in the above body and the siteID in the Uri with the ID of the site collection you want to grant access to. Microsoft provides the following roles:<div class=table-wrapper><table><thead><tr><th>Role Name</th><th>Description</th></tr></thead><tbody><tr><td></td><td></td></tr><tr><td>read</td><td>Read-only</td></tr><tr><td>write</td><td>Adds Write and related bits</td></tr><tr><td>manage</td><td>Adds Manage Lists / Designer and related bits</td></tr><tr><td>fullcontrol</td><td>All permissions</td></tr></tbody></table></div></li></ul></li></ol><p>If access to more than one site is needed, just call the permissions endpoint for each site and respective role the app registration needs.</p><p>While obviously this is more cumbersome than granting the originally requested permission, this approach provides a more secure method of managing application permissions, ensuring that apps only interact with specific site collections, thus reducing the risk of unauthorized access.</p><h3 id=examples>Examples</h3><p><img src=/post/restrict-graph-api/getBearerToken.png width=720 height=636 srcset="/post/restrict-graph-api/getBearerToken_hu5458827622032969681.png 480w, /post/restrict-graph-api/getBearerToken_hu10630132615768919918.png 1024w" loading=lazy alt="Get Bearer Token" class=gallery-image data-flex-grow=113 data-flex-basis=271px>
<img src=/post/restrict-graph-api/getSiteID.png width=720 height=531 srcset="/post/restrict-graph-api/getSiteID_hu17229586570458206775.png 480w, /post/restrict-graph-api/getSiteID_hu13577386426811082080.png 1024w" loading=lazy alt="Get siteID" class=gallery-image data-flex-grow=135 data-flex-basis=325px>
<img src=/post/restrict-graph-api/emailFailing.png width=1131 height=365 srcset="/post/restrict-graph-api/emailFailing_hu1608701126365362989.png 480w, /post/restrict-graph-api/emailFailing_hu18090683315262391397.png 1024w" loading=lazy alt="Email Failing Properly" class=gallery-image data-flex-grow=309 data-flex-basis=743px>
<img src=/post/restrict-graph-api/emailWorking.png width=1081 height=551 srcset="/post/restrict-graph-api/emailWorking_hu12642075313533132518.png 480w, /post/restrict-graph-api/emailWorking_hu17732853269987000793.png 1024w" loading=lazy alt="Email Working" class=gallery-image data-flex-grow=196 data-flex-basis=470px>
<img src=/post/restrict-graph-api/teamsFailing.png width=948 height=475 srcset="/post/restrict-graph-api/teamsFailing_hu17249025439854996100.png 480w, /post/restrict-graph-api/teamsFailing_hu9077682590099019477.png 1024w" loading=lazy alt="Teams/SPO Failing Properly" class=gallery-image data-flex-grow=199 data-flex-basis=478px>
<img src=/post/restrict-graph-api/teamsWorking.png width=1059 height=532 srcset="/post/restrict-graph-api/teamsWorking_hu4582836064697577380.png 480w, /post/restrict-graph-api/teamsWorking_hu18077073963194081764.png 1024w" loading=lazy alt="Teams Working" class=gallery-image data-flex-grow=199 data-flex-basis=477px></p></section><footer class=article-footer></footer></article><footer class=site-footer><section class=copyright>&copy;
2024 Admin Brain Dump</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>